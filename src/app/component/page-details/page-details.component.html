<div *ngIf="loading" style="margin: 30vh 50vw" class="spinner-container">
    <mat-spinner></mat-spinner>
    <div style="width: 200px; margin-top: 20px;" class="spinner-message">Loading, please wait...</div>
</div>
<div *ngIf="productItem && !loading" class="product-page">

    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <span routerLink="/">Home</span> ‚Ä∫
        <span routerLink="/categories/{{productItem.subCategory.categoryName}}">
            {{productItem.subCategory.categoryName}}
        </span> ‚Ä∫
        <span routerLink="/categories/{{productItem.subCategory.categoryName}}/{{productItem.subCategory.name}}">
            {{productItem.subCategory.name}}
        </span> ‚Ä∫
        <span>{{ productItem.productTitle }}</span>
    </nav>

    <div class="product-main">

        <section class="gallery">
            <div class="thumbs">
                <img *ngFor="let img of productItem.imageUrls" [src]="img" (mouseenter)="hoverImage(img, 0)"
                    [class.active]="img === selectedImage" />
            </div>

            <div class="image-view" (mousemove)="!isMobile && onMouseMove($event)" (mouseenter)="toggleLens(true)"
                (mouseleave)="toggleLens(false)" (click)="toggleMobileZoom()">
                <img #mainImage [src]="selectedImage" [class.mobile-zoom]="mobileZoom && isMobile" />

                <!-- üîç Desktop Lens -->
                <div #lens class="lens" *ngIf="isHovering && !isMobile"
                    [style.backgroundImage]="'url(' + selectedImage + ')'" [style.backgroundPosition]="lensPosition">
                </div>
            </div>
        </section>


        <!-- INFO SECTION -->
        <section class="info">

            <h1>{{ productItem.productTitle }}</h1>

            <!-- Rating -->
            <div class="rating">
                ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ <span>(128 reviews)</span>
            </div>

            <app-star-rating [rating]="productItem.rating"></app-star-rating>
            <!-- Price -->
            <div class="price">
                ‚Çπ {{ productItem.price }}
                <span *ngIf="productItem.discountPercent" class="discount">
                    -{{ productItem.discountPercent }}%
                </span>
            </div>

            <!-- Stock -->
            <div class="stock" [class.out]="!productItem.inStock">
                {{ productItem.inStock ? 'In Stock' : 'Out of Stock' }}
            </div>

            <!-- Variations -->
            <div *ngIf="productItem.productVariations[0]?.color !== 'no_color'" class="variants">
                <h4 class="text-danger">Select Variant</h4>
                <button *ngFor="let v of productItem.productVariations" (click)="getSize(v.size, v.color)"
                    [disabled]="v.quantity === 0" [class.selected]="
     selectedSize=== v.size &&
    selectedColor === v.color
  ">
                    {{ v.color | titlecase }} / {{ v.size }}
                </button>

            </div>
            <!-- Quantity -->
            <div class="qty">
                <label>Qty</label>
                <input type="number" min="1" [(ngModel)]="quantity">
            </div>
            <div *ngIf="!validateQuantity() && selectedColor" class="error text-danger">
                Quantity exceeds available stock ({{ maxQuantity }} available).
            </div>
            <div *ngIf="!validateQuantity() && productItem.productVariations[0]?.color == 'no_color'"
                class="error text-danger">
                Quantity exceeds available stock ({{ maxQuantity }} available).
            </div>
            <!-- Buttons -->
            <div class="actions">
                <!-- <button *ngIf="productItem.productVariations[0]?.color != 'no_color'" class="cart"
                    (click)="open(productItem)">
                    Add to Cart
                </button> -->
                <button class="btn btn-primary" [disabled]="!validateQuantity()" (click)="openSimple(productItem)">
                    Add to Cart
                </button>
                <button class="btn btn-dark">
                    Buy Now
                </button>
            </div>

            <!-- Delivery -->
            <div class="delivery">
                üöö Free delivery in 3‚Äì5 days
                üîÑ Easy 7-day returns
            </div>

        </section>
    </div>

    <!-- DETAILS TABS -->
    <section class="details">
        <details open>
            <summary>Description</summary>
            <p>{{ productItem.description }}</p>
        </details>

        <details>
            <summary>Specifications</summary>
            <ul>
                <li>High Quality</li>
                <li>12 Months Warranty</li>
            </ul>
        </details>

        <details>
            <summary>Reviews</summary>
            <p>No reviews yet</p>
        </details>
    </section>

    <section *ngIf="productItem" class="recommended-products m-5">
        <h2>Recommended for You</h2>
        <div class="d-flex align-items-center position-relative">

            <!-- Left Button -->
            <button class="scroll-btn left" (click)="scrollLeft()" [disabled]="startIndex === 0">&#8249;</button>

            <div class="recommended-container no-scroll">
                <ng-container *ngIf="recommendedProducts$ | async as recommendedProducts">
                    <ng-container
                        *ngFor="let item of recommendedProducts.slice(startIndex, startIndex + itemsPerPage); let i = index">
                        <div class="recommended-item">
                            <div *ngIf="item.discountPercent > 0" class="offer-badge">Offer</div>
                            <img [src]="item.imageUrls[0]" alt="{{ item.productTitle }}"
                                (click)="redirectToDetails(item.productId)">
                            <h5 [routerLink]="['/products', item.productId]">{{ item.productTitle }}</h5>
                            <h6><span class="text-danger">‚Çπ{{ item.price }}</span></h6>
                            <button [disabled]="!validateQuantity()" (click)="openSimple(productItem)" class="btn btn-outline-primary">Add to Cart</button>
                        </div>
                    </ng-container>
                    <!-- Show All button after last visible item -->
                    <div *ngIf="maxReached" class="recommended-item show-all-btn">
                        <button class="btn btn-primary" (click)="goToAllProducts()">Show All</button>
                    </div>
                </ng-container>
            </div>

            <!-- Right Button -->
            <button class="scroll-btn right" (click)="scrollRight()" [disabled]="maxReached">&#8250;</button>
        </div>
    </section>

</div>